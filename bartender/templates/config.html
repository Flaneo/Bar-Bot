<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Konfiguration verwalten</title>
    <style>
    /* CSS wie gehabt, unverändert */
    body {
        font-family: 'Arial', sans-serif;
        background-color: #f5f5f5;
        color: #333;
        margin: 0;
        padding: 0;
    }
    header {
        background-color: #007bff;
        color: white;
        padding: 20px;
        text-align: center;
    }
    header h1 {
        margin: 0;
        font-size: 24px;
    }
    main {
        padding: 20px;
        max-width: 900px;
        margin: 0 auto;
    }
    nav {
        text-align: center;
        margin-bottom: 20px;
    }
    nav button {
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
    }
    nav button:hover {
        background-color: #0056b3;
    }
    .config-section {
        margin-bottom: 30px;
    }
    .config-section h2 {
        font-size: 20px;
        color: #333;
        margin-bottom: 10px;
    }
    .pour-time-container {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
    }
    .pour-time-container input {
        width: 100px;
        padding: 8px;
        font-size: 14px;
        border: 1px solid #ccc;
        border-radius: 5px;
        text-align: right;
    }
    .config-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    .config-item {
        display: flex;
        align-items: center;
        justify-content: space-between; 
        background-color: white;
        padding: 10px 15px;
        border: 1px solid #ccc;
        border-radius: 8px;
        margin-bottom: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    .config-item.dragging {
        background-color: #e0e0e0; 
        transform: scale(1.05); 
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); 
        transition: background-color 0.2s, transform 0.2s; 
    }
    .config-name {
        width: 45%;
        padding: 8px;
        margin-right: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 14px;
    }
    .config-position {
        width: 20%;
        padding: 8px;
        margin-right: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 14px;
        text-align: right;
    }
    .config-drag {
      cursor: grab;
      color: #666;
      font-size: 18px;
      user-select: none;
    }
    .config-drag:active {
      cursor: grabbing;
    }
    .config-item button {
        background-color: #dc3545;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 5px 10px;
        font-size: 14px;
        cursor: pointer;
    }
    .config-item button:hover {
        background-color: #c82333;
    }
    .add-config {
        text-align: center;
        margin-top: 20px;
    }
    .add-config button {
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
    }
    .add-config button:hover {
        background-color: #0056b3;
    }
    .save-button {
        text-align: center;
        margin-top: 20px;
    }
    .save-button button {
        background-color: #28a745;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
    }
    .save-button button:hover {
        background-color: #218838;
    }
    footer {
        margin-top: 20px;
        text-align: center;
        font-size: 14px;
        color: #666;
    }

    .snackbar {
        visibility: hidden;
        min-width: 300px;
        max-width: 90%; 
        background-color: #333; 
        color: #fff;
        text-align: center;
        border-radius: 8px;
        padding: 16px 20px;
        position: fixed;
        z-index: 1000;
        left: 50%; 
        bottom: 30px; 
        transform: translateX(-50%);
        font-size: 16px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        opacity: 0; 
        transition: opacity 0.3s ease, bottom 0.3s ease;
    }
    .snackbar.show {
        visibility: visible;
        opacity: 1; 
        bottom: 50px; 
    }
    .snackbar.error {
        background-color: #f44336; 
    }
    .snackbar.success {
        background-color: #4caf50; 
    }
    </style>

    <script>
        function showSnackbar(message, type = "success") {
            const snackbar = document.getElementById("snackbar");
            snackbar.textContent = message; 
            snackbar.className = "snackbar"; 
            snackbar.classList.add(type); 
            snackbar.classList.add("show"); 

            setTimeout(() => {
                snackbar.classList.remove("show");
            }, 3000);
        }

        async function saveConfig() {
            const pourTimeInput = document.getElementById("pour-time-value").value.trim();

            const drinkItems = document.querySelectorAll("#drink-config-list .config-item");
            const config = {
                pour_time: parseInt(pourTimeInput) || 2000,
            };

            // Getränke-Daten hinzufügen
            drinkItems.forEach(drinkItem => {
                const name = drinkItem.querySelector(".config-name").value.trim();
                const position = parseInt(drinkItem.querySelector(".config-position").value.trim());
                if (name && !isNaN(position)) {
                    config[name] = position;
                }
            });

            // Pumpen-Daten auslesen
            for (let i = 1; i <= 4; i++) {
                const pumpDrink = document.getElementById(`pump${i}_drink`).value.trim();
                const pumpTime = parseInt(document.getElementById(`pump${i}_time`).value.trim()) || 1000;
                const pumpPosition = parseInt(document.getElementById(`pump${i}_position`).value.trim()) || 250;

                if (pumpDrink) {
                    config[`pump${i}`] = pumpDrink;
                }
                config[`pump${i}_time`] = pumpTime;
                config[`pump${i}_position`] = pumpPosition;
            }

            try {
                const response = await fetch("/config", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ config }),
                });

                const result = await response.json();
                if (result.status === "success") {
                    showSnackbar("Konfiguration erfolgreich gespeichert", "success");
                } else {
                    throw new Error(result.message || "Fehler beim Speichern der Konfiguration");
                }
            } catch (error) {
                showSnackbar(error.message, "error");
            }
        }

        function addDrinkConfigRow() {
            const container = document.querySelector("#drink-config-list");
            const row = document.createElement("div");
            row.className = "config-item"; 
            row.innerHTML = `
                <input type="text" class="config-name" placeholder="Name" pattern="[a-zA-Z0-9_]+" title="Nur Buchstaben, Zahlen und Unterstriche erlaubt.">
                <input type="number" class="config-position" placeholder="Position in mm">
                <span class="config-drag" draggable="true">☰</span>
                <button onclick="removeConfigRow(this)" class="remove-btn">Entfernen</button>
            `;
            container.appendChild(row);
            enableDragAndDrop();
        }

        function removeConfigRow(button) {
            const row = button.closest(".config-item");
            row.remove();
        }

        function enableDragAndDrop() {
            const list = document.querySelector(".config-list");
            list.removeEventListener("dragover", handleDragOver);
            list.addEventListener("dragover", handleDragOver);

            const items = document.querySelectorAll(".config-item");
            items.forEach(item => {
                const dragHandle = item.querySelector(".config-drag");
                if (!dragHandle) return;
                dragHandle.addEventListener("dragstart", handleDragStart);
                dragHandle.addEventListener("dragend", handleDragEnd);
                item.draggable = false;
                dragHandle.draggable = true;
            });
        }

        function handleDragStart(e) {
            const item = e.target.closest(".config-item");
            e.dataTransfer.setData("text/plain", "");
            item.classList.add("dragging");
        }

        function handleDragEnd(e) {
            const item = e.target.closest(".config-item");
            item.classList.remove("dragging");
        }

        function handleDragOver(e) {
            e.preventDefault();
            const list = e.currentTarget;
            const afterElement = getDragAfterElement(list, e.clientY);
            const dragging = document.querySelector(".dragging");
            if (!dragging) return;
            if (afterElement == null) {
                list.appendChild(dragging);
            } else {
                list.insertBefore(dragging, afterElement);
            }
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll(".config-item:not(.dragging)")];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        document.addEventListener("DOMContentLoaded", () => {
            enableDragAndDrop();
        });

    </script>
</head>
<body>
    <header>
        <h1>Konfiguration verwalten</h1>
    </header>
    <main>
        <nav>
            <button onclick="window.location.href='/'">Zurück zur Übersicht</button>
        </nav>

        <!-- Pour Time Section -->
        <section class="config-section">
            <h2>Pour Time (für 2cl)</h2>
            <div class="pour-time-container">
                <label for="pour-time-value">Pour Time:</label>
                <input type="number" id="pour-time-value" value="{{ config.pour_time }}" placeholder="2000">
            </div>
        </section>

        <!-- Drinks Configuration Section -->
        <section class="config-section">
            <h2>Getränkekonfiguration</h2>
            <div class="config-list" id="drink-config-list">
                {% for name, position in config.items() %}
                {% if name != "pour_time" and not name.startswith("pump") %}
                <div class="config-item">
                    <input type="text" class="config-name" value="{{ name }}" placeholder="Name" pattern="[a-zA-Z0-9_]+" title="Nur Buchstaben, Zahlen und Unterstriche erlaubt.">
                    <input type="number" class="config-position" value="{{ position }}" placeholder="Position in mm">
                    <span class="config-drag" draggable="true">☰</span>
                    <button onclick="removeConfigRow(this)">Entfernen</button>
                </div>
                {% endif %}
                {% endfor %}
            </div>
            <div class="add-config">
                <button onclick="addDrinkConfigRow()">Getränk hinzufügen</button>
            </div>
        </section>

        <!-- Pumps Configuration Section -->
        <section class="config-section">
            <h2>Pumpen-Konfiguration</h2>
            <p>Für jede Pumpe den Getränkenamen, die Zeit für 1 cl (in ms) und die Position in mm einstellen.</p>

            {% for i in range(1, 5) %}
            <div class="config-item">
                <span>Pumpe {{ i }} Getränk:</span>
                <input type="text" class="config-name" id="pump{{ i }}_drink" value="{{ config['pump' ~ i] or '' }}" placeholder="Getränk">
            </div>
            <div class="config-item">
                <span>Pumpe {{ i }} Zeit für 1 cl (ms):</span>
                <input type="number" class="config-position" id="pump{{ i }}_time" value="{{ config['pump' ~ i ~ '_time'] or '1000' }}" placeholder="1000">
            </div>
            <div class="config-item">
                <span>Pumpe {{ i }} Position (mm):</span>
                <input type="number" class="config-position" id="pump{{ i }}_position" value="{{ config['pump' ~ i ~ '_position'] or '250' }}" placeholder="250">
            </div>
            {% endfor %}
        </section>

        <!-- Save Button -->
        <div class="save-button">
            <button onclick="saveConfig()">Speichern</button>
        </div>
    </main>
    <footer>
        &copy; 2024 Leo Fleischmann
    </footer>
    
    <div id="snackbar" class="snackbar"></div>
</body>
</html>
